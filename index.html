<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard | ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Roleplay</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin-top: 20px;
        }
        .card {
            border-radius: 0.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .table th, .table td {
            vertical-align: middle;
            font-size: 0.9rem;
        }
        .table th {
            white-space: nowrap;
        }
        /* Style for better visibility of long URLs/Names */
        .url-cell {
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .audio-player-controls button {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card p-4">
            <h1 class="text-center mb-4 text-primary"><i class="bi bi-bar-chart-line-fill me-2"></i> Dashboard ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏• Roleplay</h1>
            
            <div id="loadingStatus" class="alert alert-info text-center">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase...
            </div>

            <div class="table-responsive">
                <table class="table table-hover table-striped" id="submissionsTable">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö</th>
                            <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•/User ID</th>
                            <th>Part / ‡∏Ç‡πâ‡∏≠</th>
                            <th>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</th>
                            <th>‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTableBody">
                        </tbody>
                </table>
            </div>
            
            <div id="noDataMessage" class="alert alert-warning text-center" style="display: none;">
                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            </div>
        </div>
    </div>

    <div class="modal fade" id="audioModal" tabindex="-1" aria-labelledby="audioModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="audioModalLabel">‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á Roleplay</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <p id="modalQuestionText" class="text-muted"></p>
            <audio id="modalAudioPlayer" controls class="w-100"></audio>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        // **‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì**
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        // üö® ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡πÉ‡∏ô Production ‡∏à‡∏£‡∏¥‡∏á ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ Service Role Key ‡∏ö‡∏ô‡∏ù‡∏±‡πà‡∏á Server 
        // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ RLS (Row Level Security) ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        const supabase = createClient(supabaseUrl, supabaseKey);

        const tableBody = document.getElementById('submissionsTableBody');
        const loadingStatus = document.getElementById('loadingStatus');
        const noDataMessage = document.getElementById('noDataMessage');
        const audioModal = new bootstrap.Modal(document.getElementById('audioModal'));
        const modalAudioPlayer = document.getElementById('modalAudioPlayer');
        const modalQuestionText = document.getElementById('modalQuestionText');

        /**
         * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á submissions (‡∏´‡∏£‡∏∑‡∏≠ View ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
         */
        async function fetchSubmissions() {
            loadingStatus.style.display = 'block';
            tableBody.innerHTML = '';

            // üí° ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ 'submissions_with_email' ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏™‡∏£‡πâ‡∏≤‡∏á View ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à 
            // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'submissions' ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ Join ‡∏î‡πâ‡∏ß‡∏¢ JS
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'submissions' ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á 'email' Placeholder

            const { data, error } = await supabase
                .from('submissions') 
                .select('*') 
                .order('created_at', { ascending: false });

            loadingStatus.style.display = 'none';

            if (error) {
                console.error('Error fetching submissions:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
                return;
            }

            if (data.length === 0) {
                noDataMessage.style.display = 'block';
                return;
            }

            // ----------------------------------------------------
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            // ----------------------------------------------------
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // 1. Index
                tr.innerHTML += `<td>${index + 1}</td>`;
                
                // 2. Name (‡πÉ‡∏ä‡πâ Name ‡∏´‡∏£‡∏∑‡∏≠ User ID ‡∏ñ‡πâ‡∏≤ Name ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á)
                const displayName = row.name || `[ID: ${row.user_id.substring(0, 8)}]`;
                tr.innerHTML += `<td>${displayName}</td>`;

                // 3. Email / User ID
                tr.innerHTML += `<td class="url-cell" title="${row.user_id}">${row.email || row.user_id}</td>`; 

                // 4. Part / Question
                tr.innerHTML += `<td>Part ${row.part_number} / ‡∏Ç‡πâ‡∏≠ ${row.question_number}</td>`;

                // 5. Question Text
                tr.innerHTML += `<td class="url-cell" title="${row.question_text}">${row.question_text}</td>`;

                // 6. Audio URL (‡πÅ‡∏™‡∏î‡∏á Link)
                tr.innerHTML += `<td class="url-cell" title="${row.audio_url}"><a href="${row.audio_url}" target="_blank">Link</a></td>`;

                // 7. Actions (Play & Download)
                tr.innerHTML += `
                    <td>
                        <div class="audio-player-controls d-flex">
                            <button class="btn btn-sm btn-primary play-btn" data-audio-url="${row.audio_url}" data-question-text="${row.question_text}">
                                <i class="bi bi-play-fill"></i> ‡πÄ‡∏•‡πà‡∏ô
                            </button>
                            <a href="${row.audio_url}" download="roleplay_${row.user_id}_p${row.part_number}_q${row.question_number}.webm" class="btn btn-sm btn-success ms-2">
                                <i class="bi bi-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                            </a>
                        </div>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            
            // ----------------------------------------------------
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Play
            // ----------------------------------------------------
            document.querySelectorAll('.play-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const audioUrl = e.currentTarget.getAttribute('data-audio-url');
                    const questionText = e.currentTarget.getAttribute('data-question-text');
                    
                    if (audioUrl) {
                        modalAudioPlayer.src = audioUrl;
                        modalQuestionText.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ${questionText}`;
                        audioModal.show();
                    } else {
                        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö URL ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á');
                    }
                });
            });
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        document.addEventListener('DOMContentLoaded', fetchSubmissions);
    </script>
</body>
</html>
