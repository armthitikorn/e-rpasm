<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard | ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Roleplay (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Bucket ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; min-height: 100vh; padding: 20px; }
        .container { max-width: 1300px; margin-top: 20px; }
        .card { border-radius: 0.75rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); }
        .table th { white-space: nowrap; background-color: #343a40 !important; color: white; }
        .url-cell { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card p-4">
            <h1 class="text-center mb-4 text-primary"><i class="bi bi-folder-fill me-2"></i> Dashboard ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤: ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å Bucket</h1>
            
            <div class="row mb-4 p-3 bg-light rounded-3 border">
                <div class="col-md-4">
                    <label for="filterDate" class="form-label fw-bold"><i class="bi bi-calendar-date me-1"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" class="form-control" id="filterDate" required>
                </div>
                <div class="col-md-8 d-flex align-items-end">
                    <button class="btn btn-primary w-100" id="fetchDataBtn" onclick="fetchAudioFiles()">
                        <i class="bi bi-search me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    </button>
                </div>
            </div>

            <div id="loadingStatus" class="alert alert-info text-center" style="display: none;">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î **‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á** ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á... (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å)
            </div>
            
            <div id="tableSection" style="display: none;">
                <h4 class="mb-3 text-secondary">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="selectedDateDisplay" class="text-dark"></span></h4>
                <div class="table-responsive">
                    <table class="table table-hover table-striped" id="submissionsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Full Path / ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå</th>
                                <th>User ID (UUID)</th>
                                <th>Part / ‡∏Ç‡πâ‡∏≠</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="submissionsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="initialMessage" class="alert alert-secondary text-center">
                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </div>
            <div id="noDataMessage" class="alert alert-warning text-center" style="display: none;">
                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å üòî
            </div>
        </div>
    </div>

    <div class="modal fade" id="audioModal" tabindex="-1" aria-labelledby="audioModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="audioModalLabel"><i class="bi bi-headset me-2"></i> ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á Roleplay</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <p id="modalFilePath" class="text-muted"></p>
            <audio id="modalAudioPlayer" controls></audio>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        // **‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì**
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        // ‡πÉ‡∏ä‡πâ Key ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (Anon Key)
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        const supabase = createClient(supabaseUrl, supabaseKey);

        const tableBody = document.getElementById('submissionsTableBody');
        const loadingStatus = document.getElementById('loadingStatus');
        const noDataMessage = document.getElementById('noDataMessage');
        const initialMessage = document.getElementById('initialMessage');
        const tableSection = document.getElementById('tableSection');
        const filterDateInput = document.getElementById('filterDate');
        const selectedDateDisplay = document.getElementById('selectedDateDisplay');
        const audioModal = new bootstrap.Modal(document.getElementById('audioModal'));
        const modalAudioPlayer = document.getElementById('modalAudioPlayer');
        const modalFilePath = document.getElementById('modalFilePath');
        
        const BUCKET_NAME = 'audios';
        
        /**
         * ‡∏™‡∏£‡πâ‡∏≤‡∏á Public URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Supabase Storage
         * ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ Bucket ‡πÅ‡∏•‡∏∞ Path ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô
         * @param {string} fullPathInBucket - Path ‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Bucket (‡πÄ‡∏ä‡πà‡∏ô: uuid/part1/q1_uuid.webm)
         */
        function getPublicFileUrl(fullPathInBucket) {
            // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á URL: [supabaseUrl]/storage/v1/object/public/[bucketName]/[filePath]
            return `${supabaseUrl}/storage/v1/object/public/${BUCKET_NAME}/${fullPathInBucket}`;
        }

        /**
         * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Bucket ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á Client
         */
        window.fetchAudioFiles = async function() {
            const selectedDate = filterDateInput.value;
            if (!selectedDate) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤!');
                return;
            }

            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏ô JavaScript (‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö UTC)
            const dateStart = new Date(selectedDate + 'T00:00:00Z');
            const dateEnd = new Date(selectedDate + 'T23:59:59Z');

            initialMessage.style.display = 'none';
            tableSection.style.display = 'none';
            noDataMessage.style.display = 'none';
            loadingStatus.style.display = 'block';
            tableBody.innerHTML = '';
            
            try {
                // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå (User UUIDs) ‡πÉ‡∏ô Bucket ‡∏Å‡πà‡∏≠‡∏ô
                const { data: rootData, error: rootError } = await supabase
                    .storage
                    .from(BUCKET_NAME)
                    .list('', { 
                        limit: 10000, // ‡πÄ‡∏û‡∏¥‡πà‡∏° limit ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                        offset: 0 
                    });

                if (rootError) throw rootError;

                const userFolders = rootData.filter(item => item.name !== '.emptyFolderPlaceholder' && item.id === null); // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÅ‡∏ï‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå (User UUIDs)

                let allFilteredFiles = [];

                // 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ User Folder ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏•‡∏∂‡∏Å 2 ‡∏ä‡∏±‡πâ‡∏ô)
                for (const folder of userFolders) {
                    // Path 1: User UUID (‡πÄ‡∏ä‡πà‡∏ô: ced98c31-d34d-4cf7-b97a-a2a03df3c23e)
                    const userPath = folder.name; 
                    
                    // ‡∏î‡∏∂‡∏á Sub-folders/Files ‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô User UUID (‡πÄ‡∏ä‡πà‡∏ô part1, part2)
                    const { data: partData, error: partError } = await supabase
                        .storage
                        .from(BUCKET_NAME)
                        .list(userPath, { limit: 10000 });

                    if (partError) throw partError;
                    
                    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤ Part Folder (‡πÄ‡∏ä‡πà‡∏ô part1) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå .webm
                    for (const partItem of partData) {
                        if (partItem.id !== null) continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏µ‡πâ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                        
                        const partPath = `${userPath}/${partItem.name}`; // ‡πÄ‡∏ä‡πà‡∏ô: uuid/part1
                        
                        const { data: fileData, error: fileError } = await supabase
                            .storage
                            .from(BUCKET_NAME)
                            .list(partPath, { limit: 10000 });

                        if (fileError) throw fileError;

                        // 3. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô JavaScript
                        const filteredFiles = fileData
                            .filter(file => file.name.endsWith('.webm') && file.created_at)
                            .map(file => {
                                const fileDate = new Date(file.created_at);
                                
                                // ‡∏Å‡∏£‡∏≠‡∏á: created_at ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á dateStart ‡πÅ‡∏•‡∏∞ dateEnd
                                if (fileDate >= dateStart && fileDate < dateEnd) {
                                    return {
                                        name: file.name,
                                        path: `${partPath}/${file.name}`, // Full Path ‡πÉ‡∏ô Bucket
                                        user_id: userPath,
                                        part: partItem.name,
                                        created_at: file.created_at
                                    };
                                }
                                return null;
                            })
                            .filter(item => item !== null);

                        allFilteredFiles = allFilteredFiles.concat(filteredFiles);
                    }
                }

                loadingStatus.style.display = 'none';
                allFilteredFiles.sort((a, b) => new Date(a.created_at) - new Date(b.created_at)); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤

                if (allFilteredFiles.length === 0) {
                    noDataMessage.style.display = 'block';
                    selectedDateDisplay.textContent = selectedDate;
                    return;
                }
                
                // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                tableSection.style.display = 'block';
                selectedDateDisplay.textContent = selectedDate;

                allFilteredFiles.forEach((file, index) => {
                    const tr = document.createElement('tr');
                    
                    const publicUrl = getPublicFileUrl(file.path);
                    const timeOnly = new Date(file.created_at).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                    
                    // ‡πÅ‡∏¢‡∏Å Question Number ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏ä‡πà‡∏ô q1_uuid.webm -> q1)
                    const matchQ = file.name.match(/q(\d+)_/i);
                    const questionNumber = matchQ ? matchQ[1] : 'N/A';
                    
                    tr.innerHTML += `<td>${index + 1}</td>`;
                    tr.innerHTML += `<td class="url-cell" title="${file.path}">${file.name}</td>`;
                    tr.innerHTML += `<td class="url-cell" title="${file.user_id}">${file.user_id.substring(0, 8)}...</td>`;
                    tr.innerHTML += `<td>${file.part} / ‡∏Ç‡πâ‡∏≠ ${questionNumber}</td>`;
                    tr.innerHTML += `<td>${timeOnly}</td>`;

                    // 5. Actions (Play & Download)
                    const downloadFileName = `${file.user_id.substring(0, 8)}_${file.part}_Q${questionNumber}_${selectedDate}.webm`;

                    tr.innerHTML += `
                        <td class="action-btns">
                            <button class="btn btn-sm btn-primary play-btn" data-audio-url="${publicUrl}" data-file-path="${file.path}">
                                <i class="bi bi-play-fill"></i> ‡πÄ‡∏•‡πà‡∏ô
                            </button>
                            <a href="${publicUrl}" download="${downloadFileName}" class="btn btn-sm btn-success ms-2">
                                <i class="bi bi-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                            </a>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
                
                // 6. Setup Event Listeners
                document.querySelectorAll('.play-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        modalAudioPlayer.pause(); 
                        modalAudioPlayer.currentTime = 0;
                        const audioUrl = e.currentTarget.getAttribute('data-audio-url');
                        const filePath = e.currentTarget.getAttribute('data-file-path');

                        if (audioUrl) {
                            modalAudioPlayer.src = audioUrl;
                            modalFilePath.textContent = `Path: ${filePath}`;
                            audioModal.show();
                            modalAudioPlayer.play();
                        } else {
                            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö URL ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á');
                        }
                    });
                });

            } catch (err) {
                loadingStatus.style.display = 'none';
                console.error('An unexpected error occurred or Storage error:', err);
                alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Bucket: ${err.message || '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RLS ‡∏Ç‡∏≠‡∏á Storage (Policy: select/read)'}`);
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initialMessage.style.display = 'block';
            tableSection.style.display = 'none';
        });
    </script>
</body>
</html>
