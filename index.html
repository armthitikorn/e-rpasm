<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard | ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Roleplay (‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1300px;
            margin-top: 20px;
        }
        .card {
            border-radius: 0.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .table th, .table td {
            vertical-align: middle;
            font-size: 0.9rem;
        }
        .table th {
            white-space: nowrap;
            background-color: #343a40 !important;
            color: white;
        }
        .url-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .action-btns button, .action-btns a {
            margin-right: 5px;
            white-space: nowrap;
        }
        #modalAudioPlayer {
            width: 100%;
            height: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card p-4">
            <h1 class="text-center mb-4 text-primary"><i class="bi bi-person-badge-fill me-2"></i> Dashboard ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏• Roleplay</h1>
            
            <div class="row mb-4 p-3 bg-light rounded-3 border">
                <div class="col-md-4">
                    <label for="filterDate" class="form-label fw-bold"><i class="bi bi-calendar-date me-1"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" class="form-control" id="filterDate" required>
                </div>
                <div class="col-md-8 d-flex align-items-end">
                    <button class="btn btn-primary w-100" id="fetchDataBtn" onclick="fetchSubmissions()">
                        <i class="bi bi-search me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    </button>
                </div>
            </div>

            <div id="loadingStatus" class="alert alert-info text-center" style="display: none;">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase...
            </div>
            
            <div id="tableSection" style="display: none;">
                <h4 class="mb-3 text-secondary">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="selectedDateDisplay" class="text-dark"></span></h4>
                <div class="table-responsive">
                    <table class="table table-hover table-striped" id="submissionsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö</th>
                                <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•/UUID ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th>
                                <th>Part / ‡∏Ç‡πâ‡∏≠</th>
                                <th>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á (‡∏ô‡∏≤‡∏ó‡∏µ)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="submissionsTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="initialMessage" class="alert alert-secondary text-center">
                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            </div>
            <div id="noDataMessage" class="alert alert-warning text-center" style="display: none;">
                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å üòî
            </div>
        </div>
    </div>

    <div class="modal fade" id="audioModal" tabindex="-1" aria-labelledby="audioModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="audioModalLabel"><i class="bi bi-headset me-2"></i> ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á Roleplay</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <p id="modalQuestionText" class="text-muted"></p>
            <audio id="modalAudioPlayer" controls></audio>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        // **‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì**
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        const supabase = createClient(supabaseUrl, supabaseKey);

        const tableBody = document.getElementById('submissionsTableBody');
        const loadingStatus = document.getElementById('loadingStatus');
        const noDataMessage = document.getElementById('noDataMessage');
        const initialMessage = document.getElementById('initialMessage');
        const tableSection = document.getElementById('tableSection');
        const filterDateInput = document.getElementById('filterDate');
        const selectedDateDisplay = document.getElementById('selectedDateDisplay');
        const audioModal = new bootstrap.Modal(document.getElementById('audioModal'));
        const modalAudioPlayer = document.getElementById('modalAudioPlayer');
        const modalQuestionText = document.getElementById('modalQuestionText');
        
        const BUCKET_NAME = 'audios';
        
        /**
         * ‡∏™‡∏£‡πâ‡∏≤‡∏á Public URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Supabase Storage
         * **‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å Bucket ‡πÑ‡∏î‡πâ**
         */
        function getPublicFileUrl(fullPath) {
            // fullPath ‡∏Ñ‡∏∑‡∏≠ row.audio_url ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å DB
            // Path ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Public URL ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Path ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Bucket ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô: uuid/part1/q1_uuid.webm)
            const storageBaseUrl = `${supabaseUrl}/storage/v1/object/public/${BUCKET_NAME}/`;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ fullPath ‡πÄ‡∏õ‡πá‡∏ô URL ‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î Base URL ‡∏ó‡∏¥‡πâ‡∏á
            const path = fullPath.startsWith(storageBaseUrl) ? 
                fullPath.replace(storageBaseUrl, '') : 
                fullPath;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Public URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô/‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            return `${storageBaseUrl}${path}`;
        }

        /**
         * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
         */
        window.fetchSubmissions = async function() {
            const selectedDate = filterDateInput.value;
            if (!selectedDate) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤!');
                return;
            }

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ß‡∏•‡∏≤ (Start of Day to End of Day ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ISO UTC)
            const dateStart = selectedDate + 'T00:00:00.000Z'; 
            const dateEnd = selectedDate + 'T23:59:59.999Z';

            // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            initialMessage.style.display = 'none';
            tableSection.style.display = 'none';
            noDataMessage.style.display = 'none';
            loadingStatus.style.display = 'block';
            tableBody.innerHTML = '';
            
            try {
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'submissions' ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                const { data, error } = await supabase
                    .from('submissions') 
                    .select('id, name, email, user_id, part_number, question_number, question_text, created_at, audio_url') 
                    .gte('created_at', dateStart) 
                    .lte('created_at', dateEnd)   
                    .order('created_at', { ascending: true }); 

                loadingStatus.style.display = 'none';

                if (error) {
                    console.error('Error fetching submissions:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message + ' (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RLS ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)');
                    return;
                }

                if (data.length === 0) {
                    noDataMessage.style.display = 'block';
                    selectedDateDisplay.textContent = selectedDate;
                    return;
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                tableSection.style.display = 'block';
                selectedDateDisplay.textContent = selectedDate;

                data.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    
                    // 1. Index
                    tr.innerHTML += `<td>${index + 1}</td>`;
                    
                    // 2. Name
                    const displayName = row.name && row.name.trim() !== '' ? row.name : `[Anon]`;
                    tr.innerHTML += `<td>${displayName}</td>`;

                    // 3. Email / User ID (‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠ UUID)
                    const displayIdentifier = row.email && row.email.trim() !== '' ? row.email : (row.user_id ? `${row.user_id.substring(0, 8)}...` : 'N/A');
                    const titleIdentifier = row.email && row.email.trim() !== '' ? row.email : row.user_id;
                    tr.innerHTML += `<td class="url-cell" title="${titleIdentifier}">${displayIdentifier}</td>`; 

                    // 4. Part / Question
                    tr.innerHTML += `<td>Part ${row.part_number} / ‡∏Ç‡πâ‡∏≠ ${row.question_number}</td>`;

                    // 5. Question Text
                    tr.innerHTML += `<td class="url-cell" title="${row.question_text}">${row.question_text}</td>`;

                    // 6. Created At (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ß‡∏•‡∏≤)
                    const date = new Date(row.created_at).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                    tr.innerHTML += `<td>${date}</td>`;

                    // 7. Actions (Play & Download)
                    const publicUrl = getPublicFileUrl(row.audio_url);
                    const downloadFileName = `${displayName.replace(/[^a-z0-9]/gi, '_')}_P${row.part_number}Q${row.question_number}_${selectedDate}.webm`;

                    tr.innerHTML += `
                        <td class="action-btns">
                            <button class="btn btn-sm btn-primary play-btn" data-audio-url="${publicUrl}" data-question-text="${row.question_text}">
                                <i class="bi bi-play-fill"></i> ‡πÄ‡∏•‡πà‡∏ô
                            </button>
                            <a href="${publicUrl}" download="${downloadFileName}" class="btn btn-sm btn-success ms-2">
                                <i class="bi bi-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                            </a>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
                
                // 3. Setup Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Play
                document.querySelectorAll('.play-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        modalAudioPlayer.pause(); 
                        modalAudioPlayer.currentTime = 0;
                        
                        const audioUrl = e.currentTarget.getAttribute('data-audio-url');
                        const questionText = e.currentTarget.getAttribute('data-question-text');
                        
                        if (audioUrl) {
                            modalAudioPlayer.src = audioUrl;
                            modalQuestionText.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ${questionText}`;
                            audioModal.show();
                        } else {
                            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö URL ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á');
                        }
                    });
                });

            } catch (err) {
                loadingStatus.style.display = 'none';
                console.error('An unexpected error occurred:', err);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console');
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠)
            initialMessage.style.display = 'block';
            tableSection.style.display = 'none';
        });
    </script>
</body>
</html>
